# 登录功能测试指南

## ✅ 已完成的功能

1. **用户登录** (`handleLogin`)
   - 支持邮箱密码登录
   - 详细的调试日志输出
   - 友好的错误提示

2. **用户注册** (`handleRegister`)
   - 支持邮箱密码注册
   - 自动邮箱验证提示
   - 注册成功后自动登录（如果不需要验证）

3. **游客登录** (`handleGuestLogin`)
   - 无需注册即可体验

4. **登出功能** (`handleLogout`)
   - 清除 Supabase 会话
   - 清除应用状态
   - 返回登录页

5. **登录状态持久化**
   - 刷新页面后自动恢复登录状态
   - 使用 Supabase 的 session 管理

## 🧪 测试步骤

### 1. 测试注册功能

1. **打开应用**
   - 访问应用页面
   - 打开浏览器控制台（F12）

2. **注册新用户**
   - 在邮箱输入框输入：`test@example.com`
   - 在密码输入框输入：`123456`（至少6位）
   - 点击"注册新账号"按钮

3. **查看控制台输出**
   ```
   📝 ========== 开始注册 ==========
   📧 邮箱: test@example.com
   🔑 密码长度: 6
   ⏳ 正在发送注册请求...
   ✅ 注册成功！
   ```

4. **可能的情况**
   - **需要邮箱验证**：会提示"请检查邮箱并点击确认链接"
   - **自动登录**：注册成功后直接进入应用

### 2. 测试登录功能

1. **使用已注册的账号登录**
   - 邮箱：`test@example.com`
   - 密码：`123456`
   - 点击"登 录"按钮

2. **查看控制台输出**
   ```
   🔐 ========== 开始登录 ==========
   📧 邮箱: test@example.com
   🔑 密码: ******
   ⏳ 正在发送登录请求...
   ✅ 登录成功！
   用户信息: { id: '...', email: '...', ... }
   会话信息: { access_token: '...', expires_at: ... }
   ```

3. **测试错误情况**
   - **错误密码**：输入错误密码，应该看到"邮箱或密码错误"提示
   - **未注册邮箱**：使用未注册的邮箱，应该看到相应错误

### 3. 测试登录状态持久化

1. **登录成功后刷新页面**
   - 按 `F5` 或 `Ctrl+R` 刷新页面
   - 查看控制台，应该看到：
     ```
     🔍 检查登录状态...
     ✅ 发现有效会话，自动恢复登录状态
     ```
   - 应该自动进入首页，而不是登录页

2. **测试登出**
   - 进入"我的"页面
   - 点击"退出登录"
   - 查看控制台输出：
     ```
     🚪 ========== 开始登出 ==========
     ✅ Supabase 登出成功
     ✅ 已清除登录状态
     ```
   - 应该返回登录页

### 4. 测试游客模式

1. **点击"以游客身份进入"**
   - 查看控制台输出：
     ```
     👤 ========== 游客登录 ==========
     ✅ 已切换到游客模式
     ```
   - 应该直接进入应用，无需登录

## 🔍 调试技巧

### 查看当前登录状态

在控制台运行：
```javascript
console.log("当前登录状态:", {
    isLoggedIn: appState.isLoggedIn,
    isGuest: appState.isGuest,
    user: appState.user
});
```

### 查看 Supabase 会话

在控制台运行：
```javascript
const client = _supabaseClient || initSupabase();
client.auth.getSession().then(({ data, error }) => {
    console.log("Supabase 会话:", data);
    console.log("错误:", error);
});
```

### 手动清除登录状态

在控制台运行：
```javascript
appState.isLoggedIn = false;
appState.isGuest = false;
appState.user = null;
window.switchPage('login');
```

## ⚠️ 常见问题

### 1. 注册后提示需要邮箱验证

**原因**：Supabase 默认启用邮箱验证

**解决方案**：
- 检查邮箱收件箱（包括垃圾邮件）
- 点击确认链接完成验证
- 或者在 Supabase 控制台 → Authentication → Settings → 禁用邮箱验证（仅用于开发测试）

### 2. 登录后刷新页面又回到登录页

**可能原因**：
- Supabase 会话过期
- 浏览器禁用了 localStorage
- Supabase 客户端未正确初始化

**排查方法**：
- 运行 `diagnoseSupabase()` 检查连接
- 检查控制台是否有错误信息
- 检查浏览器是否允许 localStorage

### 3. "Invalid login credentials" 错误

**原因**：邮箱或密码错误

**解决方案**：
- 确认邮箱和密码正确
- 如果忘记密码，需要在 Supabase 控制台重置
- 或者重新注册一个新账号

## 📝 下一步测试

登录功能测试通过后，可以继续测试：
- [ ] 首页内容加载
- [ ] 地图功能
- [ ] 绘画功能
- [ ] 个人中心功能

## 💡 提示

- 所有登录相关的操作都会在控制台输出详细的日志
- 使用控制台的过滤器可以只看登录相关的日志（搜索 "登录" 或 "🔐"）
- 如果遇到问题，运行 `diagnoseSupabase()` 进行诊断
